<html>
  <canvas id="gameCanvas" width="1440" height="740"></canvas>
  <script>
    var canvas;
    var canvasContext;
    var ballX = 50;
    var ballSpeedX = 5;
    var ballY = 50;
    var ballSpeedY = 10;
    var paddle1Y = 250;
    var paddle2Y = 250;
    var player1Score = 0;
    var player2Score = 0;
    var showingWinScreen = false;
    var showingTime = false;
    var fps = 60;
    var time = 3*fps;
    const WINNING_SCORE = 3;
    const PADDLE_HEIGHT = 100;
    const PADDLE_THICKNESS = 10;
    function calculateMousePos(evt){
      var rect = canvas.getBoundingClientRect();
      var root = document.documentElement;
      var mouseX = evt.clientX - rect.left - root.scrollLeft;
      var mouseY = evt.clientY - rect.top - root.scrollTop;
      return {x:mouseX,y:mouseY};
    }
    function handleMouseClick(evt){
      if(showingWinScreen){
        player1Score=0; player2Score=0;
        showingWinScreen=0;
      }
    }
    window.onload = function(){
      canvas = document.getElementById('gameCanvas');
      canvasContext = canvas.getContext('2d');

      setInterval(function(){
        canvasContext.font = "30px Arial";
        if(!showingTime){
          moveEverything();
        }else{
          time--;
          if(time==0){
            showingTime=false;
          }
        }
        drawEverything();
      },1000/fps);
      canvas.addEventListener('mousedown',handleMouseClick);
      canvas.addEventListener('mousemove',function(evt){
        var mousePos = calculateMousePos(evt);
        paddle1Y= mousePos.y-(PADDLE_HEIGHT/2);
      });
    }
    function ballReset(){
      if(player1Score >= WINNING_SCORE || player2Score >= WINNING_SCORE){
        showingWinScreen=true;
      }
      showingTime=true;
      time=3*fps;
      iballSpeedX = -ballSpeedX;
      ballSpeedY=0;
      ballX = canvas.width/2;
      ballY = canvas.height/2;
    }
    function computerMovement(){
      if(ballX > 3*canvas.width/4){
      var paddle2YCenter = paddle2Y + (PADDLE_HEIGHT/2);
        if(paddle2YCenter < ballY-45){
          paddle2Y+=10;
        }else if(paddle2YCenter > ballY+45){
          paddle2Y-=10;
        }
      }
    }
    function computerMovement2(){
      if(ballX < canvas.width/3){
        var paddle1YCenter = paddle1Y + (PADDLE_HEIGHT/2);
        if(paddle1YCenter < ballY-35){
          paddle1Y+=100;
        }else if(paddle1YCenter > ballY+35){
          paddle1Y-=100;
        }
      }
    }
    function moveEverything(){
      if(showingWinScreen || showingTime){
        return;
      }
      computerMovement();
      //computerMovement2();
      ballX += ballSpeedX;
      if(ballX <= 0){
        //ballSpeedX = -ballSpeedX;
        if(ballY > paddle1Y && ballY < paddle1Y+PADDLE_HEIGHT){
          ballSpeedX = -ballSpeedX;
          var deltaY = ballY-(paddle1Y+PADDLE_HEIGHT/2);
          ballSpeedY = deltaY * 0.55;
        }else{
          player2Score++;
          ballReset();
        }
      }
      if(ballX+10 > canvas.width){
        if(ballY > paddle2Y && ballY < paddle2Y+PADDLE_HEIGHT){
          ballSpeedX = -ballSpeedX;
          var deltaY = ballY-(paddle2Y+PADDLE_HEIGHT/2);
          ballSpeedY = deltaY * 0.55;
        }else{
          player1Score++;
          ballReset();
        }
      }
      ballY += ballSpeedY;
      if(ballY+10 > canvas.height || ballY <= 0){
        ballSpeedY = -ballSpeedY;
      }
    }
    function drawNet(){
      for(var i=0; i<canvas.height; i+=40){
        canvasContext.fillStyle = 'white';
        canvasContext.fillRect(canvas.width/2-1,i,2,20);
      }
    }
    function drawEverything(){
      canvasContext.fillStyle = 'black';
      canvasContext.fillRect(0,0,canvas.width,canvas.height);
      if(showingWinScreen){
        canvasContext.fillStyle = 'white';
        if(player1Score >= WINNING_SCORE){
          canvasContext.fillText("Left Player won!",canvas.width/2-100,200);
        }else{
          canvasContext.fillText("Right Player won!",canvas.width/2-100,200);
        }
        canvasContext.font = "60px Arial";
        canvasContext.fillText(player1Score + " - " + player2Score,canvas.width/2-50,350);
        canvasContext.font = "30px Arial";
        canvasContext.fillText("click to continue",canvas.width/2-100,500);
        return;
      }
      if(showingTime){
        canvasContext.fillStyle = 'white';
        canvasContext.font = "60px Arial";
        canvasContext.fillText(Math.round(time/fps),canvas.width/2-15,canvas.height/2-100);
      }
        canvasContext.fillStyle = 'white';
        canvasContext.fillRect(0,paddle1Y,PADDLE_THICKNESS,PADDLE_HEIGHT);
      canvasContext.fillStyle = 'white';
      canvasContext.fillRect(canvas.width-PADDLE_THICKNESS,paddle2Y,PADDLE_THICKNESS,PADDLE_HEIGHT);
      canvasContext.fillStyle = 'white';
      drawNet();
      canvasContext.font = "30px Arial";
      canvasContext.beginPath();
      canvasContext.arc(ballX,ballY, 10,0, Math.PI*2,true);
      canvasContext.fill();
      canvasContext.fillText(player1Score,100,100);
      canvasContext.fillText(player2Score,canvas.width-100,100);
    }
  </script>
</html>
